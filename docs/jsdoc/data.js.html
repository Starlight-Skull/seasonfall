<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: data.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: data.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { version, settings, weather } from './globals.js'
import { element, formatUnixTime, handleMouseKeyEvent } from './helpers.js'
import { fromStorage, toStorage } from './init.js'
import { handleMenuEvent, menus } from './menu.js'

window.addEventListener('load', function () {
  element('version').innerText = version
  fromStorage('settings').then(file => {
    for (const fileKey in file) {
      if (typeof settings[fileKey] === 'object') {
        for (const subKey in file[fileKey]) {
          settings[fileKey][subKey] = file[fileKey][subKey]
        }
      } else settings[fileKey] = file[fileKey]
    }
  }).catch(() => {
    console.log('File not found.')
    toStorage('settings', settings)
  }).then(() => {
    oneCallAPI()
    setInterval(oneCallAPI, settings.api.interval * 1000)
  })
  window.addEventListener('mousedown', ev => handleMouseKeyEvent(`Mouse${ev.button}`, true))
  window.addEventListener('mouseup', ev => handleMouseKeyEvent(`Mouse${ev.button}`, false))
  window.addEventListener('keydown', ev => handleMouseKeyEvent(ev.code, true))
  window.addEventListener('keyup', ev => handleMouseKeyEvent(ev.code, false))
  const pauseMenu = element('pauseMenu')
  pauseMenu.style.visibility = 'hidden'
  pauseMenu.addEventListener('click', ev => handleMenuEvent(ev.target))
  for (const menusKey in menus) {
    menus[menusKey].style.display = 'none'
  }
  menus.pause.style.display = 'flex'
  const debugMenu = element('debugMenu')
  debugMenu.style.visibility = 'hidden'
})

/**
 * Tries to get coordinates from the built-in navigator API.
 */
export async function navigate () {
  navigator.geolocation.getCurrentPosition(location => {
    settings.api.latitude = location.coords.latitude
    settings.api.longitude = location.coords.longitude
    element('lat').value = settings.api.latitude
    element('lon').value = settings.api.longitude
  })
}

/**
 * Reference for fields in 'Geocoder API' response.
 * @type {{country: string, name: string, lon: number, state: string, lat: number}}
 */
const geoCoderModel = {
  country: '',
  lat: 0,
  lon: 0,
  name: '',
  state: ''
}

/**
 * Calls the 'Geocoder API' and sets the response to the settings object.
 * @param query - The location to search for.
 * @param key - (Optional) The key to access the API. If no key is given the global value is used.
 * @returns {Promise&lt;any>} - Array of matching locations.
 */
export async function geoCoderAPI (query, key) {
  if (!key) key = settings.api.key
  if (query &amp;&amp; key &amp;&amp; typeof query === 'string' &amp;&amp; typeof key === 'string') {
    let url = 'https://api.openweathermap.org/geo/1.0/direct'
    url += `?q=${query}&amp;appid=${settings.api.key}&amp;limit=5`
    const response = await fetch(url)
    return await response.json()
  }
}

/**
 * Reference for fields in 'One Call API' response.
 * @type {{current: {rain: {"1h": number}, sunrise: number, temp: number, visibility: number, uvi: number, pressure: number, clouds: number, feels_like: number, wind_gust: number, dt: number, wind_deg: number, dew_point: number, snow: {"1h": number}, sunset: number, weather[]: {icon: string, description: string, main: string, id: number}, humidity: number, wind_speed: number}, timezone: string, timezone_offset: number, lon: number, lat: number}}
 */
const oneCallModel = {
  lat: 0,
  lon: 0,
  timezone: '',
  timezone_offset: 0,
  current: {
    dt: 0,
    sunrise: 0,
    sunset: 0,
    temp: 0,
    feels_like: 0,
    pressure: 0,
    humidity: 0,
    dew_point: 0,
    clouds: 0,
    uvi: 0,
    visibility: 0,
    wind_deg: 0,
    wind_speed: 0,
    wind_gust: 0,
    rain: { '1h': 0 },
    snow: { '1h': 0 },
    weather: [{
      id: 0,
      main: '',
      description: '',
      icon: ''
    }]
  }
}

/**
 * Calls the 'One Call API' and sets the response to the weather object.
 */
export async function oneCallAPI () {
  if (settings.api.key &amp;&amp; typeof settings.api.latitude === 'number' &amp;&amp; typeof settings.api.longitude === 'number') {
    let url = 'https://api.openweathermap.org/data/2.5/onecall'
    url += `?lat=${settings.api.latitude}&amp;lon=${settings.api.longitude}&amp;appid=${settings.api.key}&amp;exclude=minutely,hourly,daily,alerts&amp;units=metric&amp;lang=en`
    fetch(url).then(res => {
      return res.json()
    }).then(json => {
      console.log(json)
      if (!json.message) {
        weather.main = json.current.weather[0].main
        weather.description = json.current.weather[0].description
        weather.time = formatUnixTime(json.current.dt, json.timezone_offset)
        weather.sunrise = formatUnixTime(json.current.sunrise, json.timezone_offset)
        weather.sunset = formatUnixTime(json.current.sunset, json.timezone_offset)
        weather.temp = json.current.temp
        weather.tempFeelsLike = json.current.feels_like
        weather.pressure = json.current.pressure
        weather.humidity = json.current.humidity
        weather.dewPoint = json.current.dew_point
        weather.clouds = json.current.clouds
        weather.uvi = json.current.uvi
        weather.visibility = json.current.visibility
        weather.windSpeed = json.current.wind_speed
        weather.windDeg = (json.wind_deg &lt; 180) ? 'East' : 'West'
        weather.windGust = json.wind_gust || 0
        weather.rain = json.current.rain || 0
        weather.snow = json.current.snow || 0
      } else {
        // if response has an error, alert user
        window.alert(json.message)
      }
    })
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#borderControl">borderControl</a></li><li><a href="global.html#element">element</a></li><li><a href="global.html#fonts">fonts</a></li><li><a href="global.html#formatUnixTime">formatUnixTime</a></li><li><a href="global.html#fromStorage">fromStorage</a></li><li><a href="global.html#geoCoderAPI">geoCoderAPI</a></li><li><a href="global.html#geoCoderModel">geoCoderModel</a></li><li><a href="global.html#handleMenuEvent">handleMenuEvent</a></li><li><a href="global.html#handleMouseKeyEvent">handleMouseKeyEvent</a></li><li><a href="global.html#LoadImage">LoadImage</a></li><li><a href="global.html#loadSettings">loadSettings</a></li><li><a href="global.html#menuAction">menuAction</a></li><li><a href="global.html#menus">menus</a></li><li><a href="global.html#navigate">navigate</a></li><li><a href="global.html#newDrawTile">newDrawTile</a></li><li><a href="global.html#oneCallAPI">oneCallAPI</a></li><li><a href="global.html#oneCallModel">oneCallModel</a></li><li><a href="global.html#openDebugMenu">openDebugMenu</a></li><li><a href="global.html#openPauseMenu">openPauseMenu</a></li><li><a href="global.html#quit">quit</a></li><li><a href="global.html#readStorage">readStorage</a></li><li><a href="global.html#saveSettings">saveSettings</a></li><li><a href="global.html#search">search</a></li><li><a href="global.html#setKey">setKey</a></li><li><a href="global.html#setupTray">setupTray</a></li><li><a href="global.html#toStorage">toStorage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Sat Sep 17 2022 23:35:29 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
